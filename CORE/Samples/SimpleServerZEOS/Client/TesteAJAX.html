<html> 
<head>
<title>Teste de POST num servidor REST</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/myfunc.js"></script>   -->
<head>
<body>
<script type="text/javascript">

 

function myRequest(sql,username,password,retorno1,retorno2,params3)
{
    var contentType ="application/x-www-form-urlencoded";
  
        $.ajax({
                type: "POST",
                url: "/ConsultaBanco",
                headers: {"Authorization" : "Basic " +  btoa(username+":"+password),
                         'Content-Type': 'application/x-www-form-urlencoded'},
                       
                xhrFields: {
                    withCredentials: true
                },
               data: {
                     "SQL":'{"ObjectType":"toParam", "Direction":"odINOUT", "Encoded":"true", "ValueType":"ovString", "SQL":"'+sql+'"}',
                     "TESTPARAM":'{"ObjectType":"toParam", "Direction":"odINOUT", "Encoded":"true", "ValueType":"ovString", "TESTPARAM":""}'
                },
                beforeSend: function(xhr){
                 //xhr.withCredentials = true;
                 //xhr.setRequestHeader("Accept", "application/json");
                 //xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
                 //xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                 //xhr.overrideMimeType( "application/x-www-form-urlencoded" );

                 //xhr.setRequestHeader("If-Modified-Since", "Mon, 1 Oct 1990 05:00:00 GMT");
                 //xhr.setRequestHeader("Authorization", "Basic " + btoa(username+":"+password));  
              }
            }).done(function( InputValue, textStatus, jqXHR ) {
                  var  ParamsData=[];
                  var  Data=[];
                  parseJSON(InputValue, Data,ParamsData);
                  console.log(Data);

                  //pegar parametro pelo nome
                  //param =getValueOfParam('testparam',ParamsData)[0];
                  //console.log(param.ParamName + '='+ param.Value);
              
                  $(retorno1)[0].value=JSON.stringify(Data);

                  var sOut= document.getElementById(params3);
                  for(var i = 0; i < ParamsData.length; i++) {
                    param=ParamsData[i];
                    sOut.options[sOut.options.length]= new Option(param.ParamName+'='+param.Value);
                   // console.log(param.ParamName + '='+ param.Value);
                  }

                  var xdata=[];
                  xdata=toJsonDecod(Data);
                  console.log(Data);
                  $(retorno2)[0].value=JSON.stringify(xdata);

            }).fail(function( jqXHR, textStatus, errorThrown ) {
                alert("fail: " + errorThrown);
            });
};

getValueOfParam=function (code,sData) {
  return sData.filter(
      function(data){ return data.ParamName == code }
  );
}

function parseJSON (InputValue, ResultJSON, sParamsData){
                   InitPos    = InputValue.indexOf('"RESULT":[') + 10;
                   vTempValue = InputValue.substr(InitPos, InputValue.indexOf(']}') - InitPos+2);
                   InputValue = InputValue.replace(vTempValue,"");
                   SetData(InputValue  , sParamsData);
                   if (vTempValue!=''){ ResultJSON.push(JSON.parse(atob(vTempValue))); }

 }

function SetData(InputValue  , ParamsData ,CallBack){
  JsonParser = JSON.parse(InputValue);
 
 for(var i = 0; i < JsonParser.PARAMS.length; i++) {
 	bJsonValue=JsonParser.PARAMS[i];
    if (bJsonValue.Direction!="odINOUT") { continue;}
    if (bJsonValue.ObjectType!="toParam") {continue;}
      
    var JSONParam={ParamName       : Object.keys(bJsonValue)[4],
               ObjectValue     : Object.values(bJsonValue)[3],
               ObjectDirection : Object.values(bJsonValue)[1],
               Encoded         : Object.values(bJsonValue)[2]=="true"};

    if (JSONParam.Encoded){
         vValue = atob(Object.values(bJsonValue)[4]);
     }
    else { vValue = Object.values(bJsonValue)[4]; }
    JSONParam.Value=vValue;
    //rs={};
    //rs[JSONParam.ParamName]=JSON.stringify(JSONParam);
    if (CallBack) {CallBack(JSONParam.ParamName,JSONParam.ObjectValue);}
    ParamsData.push(JSONParam);
  }	
}

function toJsonDecod(sdata) {
	data=sdata[0];


    FieldCount=data.sql[0].length;
    RowCount=data.sql[1].length;
    fields=[];

    for(var i = 0; i < FieldCount; i++) {
       fields.push({"name" : data.sql[0][i].Field, "label" : data.sql[0][i].Field});
    }

    var vdata=[];

    for(var j = 0; j < RowCount; j++) {
      d=data.sql[1][j];
      rs={};
      for(var i = 0; i < FieldCount; i++) {
        svalor=d[i];
        skey=data.sql[0][i].Field ;
        
        //rs[skey]=  ((data.sql[0][i].Type == 'ftWideString') ?  atob(svalor) : svalor); 
        if ((data.Encoded) && (data.sql[0][i].Type == 'ftWideString'))  {
           svalor= atob(svalor); 
           d[i]=svalor;
        }  

        rs[skey]= svalor;   

       }
       vdata.push(rs);
    }
    return {'fields':fields,"data":vdata};
}

function toJsonFmt(sdata) {
	data=sdata[0];
    FieldCount=data.sql[0].length;
    RowCount=data.sql[1].length;
    fields=[]

    for(var i = 0; i < FieldCount; i++) {
       fields.push({"name" : data.sql[0][i].Field, "label" : data.sql[0][i].Field});
    }

    var vdata=[];

    for(var j = 0; j < RowCount; j++) {
      d=data.sql[1][j];
      rs={};
      for(var i = 0; i < FieldCount; i++) {
        svalor=d[i];
        skey=data.sql[0][i].Field ;
        
        rs[skey]=  ((data.sql[0][i].Type == 'ftWideString') ?  atob(svalor) : svalor); 
        
       }
       vdata.push(rs);
    }
    return {'fields':fields,"data":vdata};
}


function myFunction (){
  var username = 'testserver';
  var password = 'testserver';
    var sql1=btoa($('#cmdSQL1')[0].value);
    var sql2=btoa($('#cmdSQL2')[0].value);
    var sql3=btoa($('#cmdSQL3')[0].value);
    
     myRequest(sql1,username,password,'#cmdRetorno1','#cmdRetorno21','cmdParam21');
   //  myRequest(sql2,username,password,'#cmdRetorno2','#cmdRetorno22','cmdParam22');
   //  myRequest(sql3,username,password,'#cmdRetorno3','#cmdRetorno23','cmdParam23');

};



/*
function convertStringToBase64(string) 
{ 
  var out='', charCode=0, i=0, length=string.length; 
  var puffer=[];
  var base64EncodeChars ="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
  var dig1, dig2, dig3, dig4;

  var i = 0; 
  while(i < string.length) 
  { 
    charCode = string.charCodeAt(i++);
    if(charCode<0x80)  
    { 
      puffer[puffer.length]=charCode; 
    } 
    else if(charCode<0x800) 
    { 
      puffer[puffer.length]=0xc0|(charCode>>6); 
      puffer[puffer.length]=0x80|(charCode&0x3f); 
    }  
    else if(charCode<0x10000) 
    { 
      puffer[puffer.length]=0xe0|(charCode>>12); 
      puffer[puffer.length]=0x80|((charCode>>6)&0x3f); 
      puffer[puffer.length]=0x80|(charCode&0x3f); 
    }  
    else 
    { 
      puffer[puffer.length]=0xf0|(charCode>>18); 
      puffer[puffer.length]=0x80|((charCode>>12)&0x3f); 
      puffer[puffer.length]=0x80|((charCode>>6)&0x3f); 
      puffer[puffer.length]=0x80|(charCode&0x3f); 
    }  
    if(i==length) 
    { 
      while(puffer.length%3)  
      { 
        puffer[puffer.length]=NaN;
      } 
    } 
    if(puffer.length>2) 
    { 
      dig1 = puffer[0]>>2;
      dig2 = ((puffer[0]&3)<<4)|(puffer[1]>>4);
      dig3 = ((puffer[1]&15)<<2)|(puffer[2]>>6);
      dig4 = puffer[2]&63;

      if (isNaN(puffer[1])) {
        dig3 = dig4 = 64;
      } else if (isNaN(puffer[2])) {
        dig4 = 64;
      }

      puffer.shift();
      puffer.shift();
      puffer.shift();

      out+=base64EncodeChars.charAt(dig1); 
      out+=base64EncodeChars.charAt(dig2); 
      out+=base64EncodeChars.charAt(dig3); 
      out+=base64EncodeChars.charAt(dig4);
    } 
  } 
  return out; 
}

function base64ToBlob(byteString) {
  // write the bytes of the string to an ArrayBuffer
  var ab = new ArrayBuffer(byteString.length);
  var ia = new Uint8Array(ab);
  for (var i = 0; i < byteString.length; i++) {
    ia[i] = byteString.charCodeAt(i);
  }

  // write the ArrayBuffer to a blob, and you're done
  var blob = new Blob([ab], {type: 'application/pdf'});
  return blob;
};
function stringToAscii(s)
{
  var ascii="";
  if(s.length>0)
    for(i=0; i<s.length; i++)
    {
      var c = ""+s.charCodeAt(i);
      while(c.length < 3)
       c = "0"+c;
      ascii += c;
    }
  return(ascii);
}

convertUtf8ToAscii = function (str) {
    var asciiStr = "";
    var refTable = { // Reference table Unicode vs ASCII
        199: 128, 252: 129, 233: 130, 226: 131, 228: 132, 224: 133, 231: 135, 234: 136, 235: 137, 232: 138,
        239: 139, 238: 140, 236: 141, 196: 142, 201: 144, 244: 147, 246: 148, 242: 149, 251: 150, 249: 151
    };
    for(var i = 0; i < str.length; i++){
        var ascii = refTable[str.charCodeAt(i)];
        if (ascii != undefined)
            asciiStr += "%" +ascii;
        else
            asciiStr += str[i];
    }
    return asciiStr;
}
*/


/*
var xhr = new XMLHttpRequest();
xhr.open("GET", "/GetListaAlunos", true);
//xhr.withCredentials = true;
    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
    xhr.setRequestHeader("If-Modified-Since", "Mon, 1 Oct 1990 05:00:00 GMT");
    xhr.setRequestHeader("Authorization", "Basic " + btoa("testsever:testsever"));

xhr.onload = function () {
    console.log(xhr.responseText);
};
xhr.send(); 

var sql=btoa('SELECT FIRST 5 * FROM POFUNC');
$.ajax
  ({
    type: "POST",
    url: "/ConsultaBanco",
    username : username,  password :password,
    xhrFields: {
      withCredentials: true
   },
   crossDomain: true,
    dataType: 'json',
    async: false,
    data: {"SQL":'{"ObjectType":"toParam", "Direction":"odINOUT", "ValueType":"ovString", "SQL":"'+sql+'"}'
         }

      ,
     beforeSend: function(xhr){
       xhr.withCredentials = true;
       xhr.setRequestHeader("Accept", "application/json");
       xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
       xhr.setRequestHeader("If-Modified-Since", "Mon, 1 Oct 1990 05:00:00 GMT");
       xhr.setRequestHeader("Authorization", "Basic " + btoa(username+":"+password));  
    },
    success: function (data){
        console.log(data);
        $('#output').html(data);
    },

    error:function(xhr, status, error) {
                               // alert("error");
                                console.log(xhr);
     }
});
*/




</script>

   <form method="POST" action="/GetListaAlunos">
     <p>Teste de POST num servidor REST</p>
     <table border="0" width="100%">
        <tr>
           <td width="100%">Comando SQL</td>
        </tr>
        <tr>
           <td width="33%">
              <textarea placeholder=" digite o seu sql aqui" id="cmdSQL1" name="cmdSQL1" cols="50" rows="2">SELECT FIRST 500 * FROM POFUNC</textarea>     
              <textarea placeholder=" digite o seu sql aqui" id="cmdSQL2" name="cmdSQL2" cols="50" rows="2">SELECT FIRST 100 NM_FUNC FROM POFUNC</textarea>
              <textarea placeholder=" digite o seu sql aqui" id="cmdSQL3" name="cmdSQL3" cols="50" rows="2">SELECT FIRST 1 CD_FUNC FROM POFUNC</textarea>
           </td>
        </tr>
        <tr>
           <td width="100%">Retorno</td>
        </tr>
        <tr>
           <td width="100%">
              <textarea placeholder=" retorno do sql" id="cmdRetorno1" name="cmdRetorno1" cols="50" rows="20"></textarea>     
              <textarea placeholder=" retorno do sql" id="cmdRetorno2" name="cmdRetorno2" cols="50" rows="20"></textarea> 
              <textarea placeholder=" retorno do sql" id="cmdRetorno3" name="cmdRetorno3" cols="50" rows="20"></textarea> 
           </td>
        </tr>
        <tr>
           <td width="100%">
             <textarea placeholder=" retorno do sql" id="cmdRetorno21" name="cmdRetorno21" cols="50" rows="20"></textarea> 
             <textarea placeholder=" retorno do sql" id="cmdRetorno22" name="cmdRetorno22" cols="50" rows="20"></textarea> 
             <textarea placeholder=" retorno do sql" id="cmdRetorno23" name="cmdRetorno23" cols="50" rows="20"></textarea> 
           </td>
        </tr>

        <tr>
           <td width="100%">
             <select style="width: 32%;"  id="cmdParam21" name="cmdParam21" size="10"></select> 
             <select style="width: 32%;" id="cmdParam22" name="cmdParam22" size="10" ></select> 
             <select style="width: 32%;" id="cmdParam23" name="cmdParam23" size="10" ></select> 
           </td>
        </tr>
        <tr>
           <td width="14%"></td><td width="86%"><input type="submit" value="Listar Alunos" name=""></td>
        </tr> 
     </table>
   </form>
<input type="button" id="btnSearch" value="Search" onclick="myFunction();" />

</body>
</html>
